name: Go Project Release

on:
  workflow_call:
    inputs:
      registry:
        description: "Docker registry"
        required: false
        type: string
        default: "ghcr.io"
      tag-prefix:
        description: "Tag prefix (e.g., v for v1.0.0)"
        required: false
        type: string
        default: "v"
      migration-tag-prefix:
        description: "Migration tag prefix (e.g., mig for mig1.0.0)"
        required: false
        type: string
        default: "mig"
      images:
        description: "JSON array of image configurations [{name, dockerfile}]"
        required: false
        type: string
        default: '[{"name": "${{ github.event.repository.name }}", "dockerfile": "Dockerfile"}]'
      migration-images:
        description: "JSON array of migration image configurations [{name, dockerfile}]"
        required: false
        type: string
        default: "[]"
      image-base-path:
        description: "Base path for Dockerfiles (prepended to dockerfile paths)"
        required: false
        type: string
        default: ""
      build-context:
        description: "Docker build context path"
        required: false
        type: string
        default: "."
      platforms:
        description: "Target platforms (comma-separated)"
        required: false
        type: string
        default: "linux/amd64"
      enable-provenance:
        description: "Enable build provenance attestation"
        required: false
        type: boolean
        default: true
      enable-sbom:
        description: "Enable SBOM attestation"
        required: false
        type: boolean
        default: true
    secrets:
      registry-username:
        description: "Registry username"
        required: true
      registry-password:
        description: "Registry password/token"
        required: true

permissions:
  actions: read
  contents: read
  packages: write
  id-token: write
  attestations: write

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      release-tag: ${{ steps.tag.outputs.release-tag }}
      is-migration: ${{ steps.tag.outputs.is-migration }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine tag
        id: tag
        run: |
          if [ "${{ github.ref_type }}" != "tag" ]; then
            echo "Not a tag ref, skipping tag determination."
            exit 0
          fi
          TAG_NAME="${{ github.ref_name }}"
          PREFIX="${{ inputs.tag-prefix }}"
          MIG_PREFIX="${{ inputs.migration-tag-prefix }}"
          if [[ "$TAG_NAME" == "$MIG_PREFIX"* ]]; then
            RELEASE_TAG="${TAG_NAME#"$MIG_PREFIX"}"
            IS_MIGRATION="true"
          elif [[ "$TAG_NAME" == "$PREFIX"* ]]; then
            RELEASE_TAG="${TAG_NAME#"$PREFIX"}"
            IS_MIGRATION="false"
          else
            echo "Tag does not match expected prefixes."
            exit 1
          fi

          echo "release-tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"
          echo "is-migration=$IS_MIGRATION" >> "$GITHUB_OUTPUT"

  build-and-push:
    name: Build and Push Docker Image
    if: startsWith(github.ref_name, inputs.tag-prefix)
    uses: ./.github/workflows/dockerfile_build_and_push.yml
    with:
      images: ${{ inputs.images }}
      base-path: ${{ inputs.image-base-path }}
      build-context: ${{ inputs.build-context }}
      registry: ${{ inputs.registry }}
      tag: ${{ github.ref_name }}
      tag-prefix: ${{ inputs.tag-prefix }}
      platforms: ${{ inputs.platforms }}
      enable-provenance: ${{ inputs.enable-provenance }}
      enable-sbom: ${{ inputs.enable-sbom }}
    secrets:
      registry-username: ${{ secrets.registry-username }}
      registry-password: ${{ secrets.registry-password }}

  build-and-push-migration:
    name: Build and Push Migration Docker Image
    if: startsWith(github.ref_name, inputs.migration-tag-prefix)
    uses: ./.github/workflows/dockerfile_build_and_push.yml
    with:
      images: ${{ inputs.migration-images }}
      base-path: ${{ inputs.image-base-path }}
      build-context: ${{ inputs.build-context }}
      registry: ${{ inputs.registry }}
      tag: ${{ github.ref_name }}
      tag-prefix: ${{ inputs.migration-tag-prefix }}
      platforms: ${{ inputs.platforms }}
      enable-provenance: ${{ inputs.enable-provenance }}
      enable-sbom: ${{ inputs.enable-sbom }}
    secrets:
      registry-username: ${{ secrets.registry-username }}
      registry-password: ${{ secrets.registry-password }}
