name: Go Project Release

on:
  workflow_call:
    inputs:
      registry:
        description: "Default registry for Docker and Helm"
        required: false
        type: string
        default: "ghcr.io"
      repository:
        description: "Default repository path in registry (e.g., owner/repo-name)"
        required: true
        type: string
      helm-registry:
        description: "Helm OCI registry (overrides default registry if set)"
        required: false
        type: string
        default: ""
      helm-repository:
        description: "Helm repository path (overrides default repository if set)"
        required: false
        type: string
        default: ""
      enable-helm-release:
        description: "Enable Helm chart release"
        required: false
        type: boolean
        default: false
      tag-prefix:
        description: "Tag prefix (e.g., v for v1.0.0)"
        required: false
        type: string
        default: "v"
      migration-tag-prefix:
        description: "Migration tag prefix (e.g., mig for mig1.0.0)"
        required: false
        type: string
        default: "mig"
      images:
        description: "JSON array of image configurations [{name, dockerfile}]"
        required: false
        type: string
        default: '[{"name": "${{ github.event.repository.name }}", "dockerfile": "Dockerfile"}]'
      migration-images:
        description: "JSON array of migration image configurations [{name, dockerfile}]"
        required: false
        type: string
        default: "[]"
      image-base-path:
        description: "Base path for Dockerfiles (prepended to dockerfile paths)"
        required: false
        type: string
        default: ""
      build-context:
        description: "Docker build context path"
        required: false
        type: string
        default: "."
      platforms:
        description: "Target platforms (comma-separated)"
        required: false
        type: string
        default: "linux/amd64"
      enable-provenance:
        description: "Enable build provenance attestation"
        required: false
        type: boolean
        default: true
      enable-sbom:
        description: "Enable SBOM attestation"
        required: false
        type: boolean
        default: true
      charts:
        description: "JSON array of chart configurations [{dir}]"
        required: false
        type: string
        default: "[]"
      chart-base-path:
        description: "Base path for Helm charts (prepended to chart dirs)"
        required: false
        type: string
        default: ""
      helm-version:
        description: "Helm version to use"
        required: false
        type: string
        default: "v3.19.2"
      enable-chart-signing:
        description: "Enable chart signing with GPG"
        required: false
        type: boolean
        default: false
    secrets:
      registry-username:
        description: "Registry username"
        required: true
      registry-password:
        description: "Registry password/token"
        required: true
      helm-registry-username:
        description: "Helm registry username"
        required: false
      helm-registry-password:
        description: "Helm registry password/token"
        required: false
      gpg-private-key:
        description: "GPG private key for signing (base64 encoded)"
        required: false
      gpg-key-name:
        description: "GPG key name for signing"
        required: false
      gpg-passphrase:
        description: "GPG key passphrase"
        required: false

permissions:
  actions: read
  contents: read
  packages: write
  id-token: write
  attestations: write

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      release-tag: ${{ steps.tag.outputs.release-tag }}
      is-migration: ${{ steps.tag.outputs.is-migration }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine tag
        id: tag
        run: |
          if [ "${{ github.ref_type }}" != "tag" ]; then
            echo "Not a tag ref, skipping tag determination."
            exit 0
          fi
          TAG_NAME="${{ github.ref_name }}"
          PREFIX="${{ inputs.tag-prefix }}"
          MIG_PREFIX="${{ inputs.migration-tag-prefix }}"
          if [[ "$TAG_NAME" == "$MIG_PREFIX"* ]]; then
            RELEASE_TAG="${TAG_NAME#"$MIG_PREFIX"}"
            IS_MIGRATION="true"
          elif [[ "$TAG_NAME" == "$PREFIX"* ]]; then
            RELEASE_TAG="${TAG_NAME#"$PREFIX"}"
            IS_MIGRATION="false"
          else
            echo "Tag does not match expected prefixes."
            exit 1
          fi

          echo "release-tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"
          echo "is-migration=$IS_MIGRATION" >> "$GITHUB_OUTPUT"

  build-and-push:
    name: Build and Push Docker Image
    if: startsWith(github.ref_name, inputs.tag-prefix)
    uses: ./.github/workflows/dockerfile_build_and_push.yml
    with:
      images: ${{ inputs.images }}
      base-path: ${{ inputs.image-base-path }}
      build-context: ${{ inputs.build-context }}
      registry: ${{ inputs.registry }}
      repository: ${{ inputs.repository }}
      tag: ${{ github.ref_name }}
      tag-prefix: ${{ inputs.tag-prefix }}
      platforms: ${{ inputs.platforms }}
      enable-provenance: ${{ inputs.enable-provenance }}
      enable-sbom: ${{ inputs.enable-sbom }}
    secrets:
      registry-username: ${{ secrets.registry-username }}
      registry-password: ${{ secrets.registry-password }}

  build-and-push-migration:
    name: Build and Push Migration Docker Image
    if: startsWith(github.ref_name, inputs.migration-tag-prefix)
    uses: ./.github/workflows/dockerfile_build_and_push.yml
    with:
      images: ${{ inputs.migration-images }}
      base-path: ${{ inputs.image-base-path }}
      build-context: ${{ inputs.build-context }}
      registry: ${{ inputs.registry }}
      repository: ${{ inputs.repository }}
      tag: ${{ github.ref_name }}
      tag-prefix: ${{ inputs.migration-tag-prefix }}
      platforms: ${{ inputs.platforms }}
      enable-provenance: ${{ inputs.enable-provenance }}
      enable-sbom: ${{ inputs.enable-sbom }}
    secrets:
      registry-username: ${{ secrets.registry-username }}
      registry-password: ${{ secrets.registry-password }}

  helm-package-and-push:
    name: Package and Push Helm Chart
    if: inputs.enable-helm-release && fromJson(inputs.charts)[0] != null && startsWith(github.ref_name, inputs.tag-prefix)
    uses: ./.github/workflows/helm_chart_build_and_push.yml
    with:
      charts: ${{ inputs.charts }}
      base-path: ${{ inputs.chart-base-path }}
      registry: ${{ inputs.helm-registry != '' && inputs.helm-registry || inputs.registry }}
      repository: ${{ inputs.helm-repository != '' && inputs.helm-repository || inputs.repository }}
      helm-version: ${{ inputs.helm-version }}
      enable-signing: ${{ inputs.enable-chart-signing }}
      enable-provenance: ${{ inputs.enable-provenance }}
    secrets:
      registry-username: ${{ secrets.helm-registry-username != '' && secrets.helm-registry-username || secrets.registry-username }}
      registry-password: ${{ secrets.helm-registry-password != '' && secrets.helm-registry-password || secrets.registry-password }}
      gpg-private-key: ${{ secrets.gpg-private-key }}
      gpg-key-name: ${{ secrets.gpg-key-name }}
      gpg-passphrase: ${{ secrets.gpg-passphrase }}
