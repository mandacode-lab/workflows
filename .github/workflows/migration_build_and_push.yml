name: Migration Build and Push

on:
  workflow_call:
    inputs:
      image-name:
        description: 'Full migration image name (e.g., ghcr.io/owner/app-migration)'
        required: true
        type: string
      migration-dir:
        description: 'Path to migration directory containing VERSION file'
        required: true
        type: string
      dockerfile-path:
        description: 'Path to migration Dockerfile'
        required: true
        type: string
      registry:
        description: 'Docker registry'
        required: false
        type: string
        default: 'ghcr.io'
    secrets:
      registry-username:
        description: 'Registry username'
        required: true
      registry-password:
        description: 'Registry password/token'
        required: true

permissions:
  actions: read
  contents: read
  packages: write

jobs:
  build-and-push:
    name: Build and Push Migration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Read VERSION file
        id: version
        run: |
          MIGRATION_DIR="${{ inputs.migration-dir }}"
          VERSION_FILE="${MIGRATION_DIR}/VERSION"

          if [ -f "$VERSION_FILE" ]; then
            VERSION=$(cat "$VERSION_FILE" | tr -d '[:space:]')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Migration version: $VERSION"
          else
            echo "âŒ VERSION file not found: $VERSION_FILE"
            exit 1
          fi

      - name: Determine if version changed
        id: changed
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          IMAGE_NAME="${{ inputs.image-name }}"

          # Check if this version already exists
          if docker manifest inspect ${IMAGE_NAME}:${VERSION} >/dev/null 2>&1; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ… Version ${VERSION} already exists, skipping build"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ†• Version ${VERSION} is new, will build"
          fi

      - name: Generate image tags
        id: tags
        if: steps.changed.outputs.changed == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          IMAGE_NAME="${{ inputs.image-name }}"

          # Primary tag: version
          TAGS="${IMAGE_NAME}:${VERSION}"

          # Add latest tag only for stable versions (no suffix like -beta, -alpha, -rc)
          if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            TAGS="${TAGS},${IMAGE_NAME}:latest"
            echo "âœ… Stable version detected, will tag as latest"
          else
            echo "âš ï¸ Pre-release version detected (${VERSION}), latest tag will not be added"
          fi

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "Generated tags:"
          echo "$TAGS" | tr ',' '\n'

      - name: Login to Registry
        if: steps.changed.outputs.changed == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ secrets.registry-username }}
          password: ${{ secrets.registry-password }}

      - name: Build and push migration image
        if: steps.changed.outputs.changed == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ inputs.dockerfile-path }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          IMAGE_NAME="${{ inputs.image-name }}"
          CHANGED="${{ steps.changed.outputs.changed }}"

          echo "### ðŸ—„ï¸ Migration Image" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${IMAGE_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY

          if [ "$CHANGED" = "true" ]; then
            echo "**Status:** ðŸ†• Built and pushed new image" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.tags.outputs.tags }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âœ… Version already exists, skipped build" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Existing image:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${IMAGE_NAME}:${VERSION}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run migration:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker run --rm -e DATABASE_URL=\"postgres://...\" ${IMAGE_NAME}:${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
