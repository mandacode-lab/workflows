name: Helm Package

# Reusable workflow for packaging and pushing Helm charts to OCI registries
# Supports: GitHub Container Registry (GHCR), Docker Hub, Harbor, and other OCI-compatible registries
# Includes optional GPG signing support
#
# Usage example:
#   jobs:
#     helm-package:
#       uses: your-org/workflows/.github/workflows/helm-package.yml@main
#       with:
#         charts: '[{"dir": "charts/myapp"}]'
#         registry: ghcr.io
#         repository: ${{ github.repository }}
#       secrets:
#         registry-username: ${{ github.actor }}
#         registry-password: ${{ secrets.GITHUB_TOKEN }}

on:
  workflow_call:
    inputs:
      charts:
        description: 'JSON array of chart configurations [{"dir": "path/to/chart"}]'
        required: true
        type: string
      base-path:
        description: "Base path prepended to chart directories"
        required: false
        type: string
        default: ""
      registry:
        description: "OCI registry for Helm charts (e.g., ghcr.io, registry-1.docker.io)"
        required: false
        type: string
        default: "ghcr.io"
      repository:
        description: "Repository path in registry (e.g., owner/repo-name)"
        required: true
        type: string
      helm-version:
        description: "Helm version to use"
        required: false
        type: string
        default: "v4.0.4"
      enable-signing:
        description: "Enable chart signing with GPG"
        required: false
        type: boolean
        default: false
      enable-provenance:
        description: "Enable build provenance attestation"
        required: false
        type: boolean
        default: false
      skip-existing:
        description: "Skip push if chart version already exists in registry"
        required: false
        type: boolean
        default: true
    secrets:
      registry-username:
        description: "Registry username"
        required: true
      registry-password:
        description: "Registry password/token"
        required: true
      gpg-private-key:
        description: "GPG private key for signing (base64 encoded)"
        required: false
      gpg-key-name:
        description: "GPG key name/email for signing"
        required: false
      gpg-passphrase:
        description: "GPG key passphrase"
        required: false

permissions:
  contents: read
  packages: write
  id-token: write
  attestations: write

jobs:
  package-and-push:
    name: Package ${{ matrix.chart.dir }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: fromJson(inputs.charts) != null && fromJson(inputs.charts)[0] != null
    strategy:
      matrix:
        chart: ${{ fromJson(inputs.charts) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ inputs.helm-version }}

      - name: Resolve chart path
        id: paths
        run: |
          CHART_DIR="${{ matrix.chart.dir }}"
          if [ -n "${{ inputs.base-path }}" ]; then
            CHART_DIR="${{ inputs.base-path }}/${CHART_DIR}"
          fi

          # Validate Chart.yaml exists
          if [ ! -f "$CHART_DIR/Chart.yaml" ]; then
            echo "âŒ Error: Chart.yaml not found at: $CHART_DIR"
            exit 1
          fi

          echo "chart-dir=$CHART_DIR" >> "$GITHUB_OUTPUT"
          echo "âœ… Chart found: $CHART_DIR"

      - name: Extract chart metadata
        id: meta
        run: |
          CHART_DIR="${{ steps.paths.outputs.chart-dir }}"
          CHART_NAME=$(yq eval '.name' "$CHART_DIR/Chart.yaml")
          CHART_VERSION=$(yq eval '.version' "$CHART_DIR/Chart.yaml")
          CHART_APP_VERSION=$(yq eval '.appVersion // "N/A"' "$CHART_DIR/Chart.yaml")
          CHART_TYPE=$(yq eval '.type // "application"' "$CHART_DIR/Chart.yaml")

          {
            echo "name=$CHART_NAME"
            echo "version=$CHART_VERSION"
            echo "app-version=$CHART_APP_VERSION"
            echo "type=$CHART_TYPE"
          } >> "$GITHUB_OUTPUT"

          echo "ðŸ“¦ Chart Metadata:"
          echo "  Name: $CHART_NAME"
          echo "  Version: $CHART_VERSION"
          echo "  App Version: $CHART_APP_VERSION"
          echo "  Type: $CHART_TYPE"

      - name: Setup GPG
        if: inputs.enable-signing
        env:
          GPG_PRIVATE_KEY: ${{ secrets.gpg-private-key }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "âŒ Error: GPG signing enabled but gpg-private-key secret not provided"
            exit 1
          fi

          echo "$GPG_PRIVATE_KEY" | base64 -d | gpg --import --batch --yes
          echo "âœ… GPG key imported"

      - name: Login to OCI registry
        run: |
          echo "${{ secrets.registry-password }}" | helm registry login "${{ inputs.registry }}" \
            --username "${{ secrets.registry-username }}" \
            --password-stdin
          echo "âœ… Logged in to ${{ inputs.registry }}"

      - name: Update chart dependencies
        run: |
          CHART_DIR="${{ steps.paths.outputs.chart-dir }}"
          if [ -f "$CHART_DIR/Chart.lock" ] || [ -f "$CHART_DIR/requirements.lock" ]; then
            echo "ðŸ“¥ Updating chart dependencies..."
            helm dependency update "$CHART_DIR"
          else
            echo "â„¹ï¸ No dependencies to update"
          fi

      - name: Package chart
        id: package
        env:
          CHART_DIR: ${{ steps.paths.outputs.chart-dir }}
          ENABLE_SIGNING: ${{ inputs.enable-signing }}
          GPG_KEY_NAME: ${{ secrets.gpg-key-name }}
          GPG_PASSPHRASE: ${{ secrets.gpg-passphrase }}
        run: |
          mkdir -p .helm-packages

          if [ "$ENABLE_SIGNING" = "true" ]; then
            echo "ðŸ” Packaging and signing chart..."
            echo "$GPG_PASSPHRASE" | helm package "$CHART_DIR" \
              --destination .helm-packages \
              --sign \
              --key "$GPG_KEY_NAME" \
              --keyring ~/.gnupg/pubring.gpg \
              --passphrase-fd 0
          else
            echo "ðŸ“¦ Packaging chart..."
            helm package "$CHART_DIR" --destination .helm-packages
          fi

          PACKAGE_FILE=$(ls .helm-packages/*.tgz)
          echo "package-file=$PACKAGE_FILE" >> "$GITHUB_OUTPUT"
          echo "âœ… Chart packaged: $PACKAGE_FILE"

          ls -lh .helm-packages/

      - name: Check if chart version already exists
        if: inputs.skip-existing
        id: check-exists
        env:
          REGISTRY: ${{ inputs.registry }}
          REPOSITORY: ${{ inputs.repository }}
          CHART_NAME: ${{ steps.meta.outputs.name }}
          CHART_VERSION: ${{ steps.meta.outputs.version }}
        run: |
          echo "ðŸ” Checking if chart version already exists..."

          if helm pull "oci://${REGISTRY}/${REPOSITORY}/${CHART_NAME}" --version "${CHART_VERSION}" --destination /tmp 2>/dev/null; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "âš ï¸ Chart ${CHART_NAME}:${CHART_VERSION} already exists in registry"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "âœ… Chart ${CHART_NAME}:${CHART_VERSION} does not exist, will push"
          fi

      - name: Push chart to OCI registry
        if: ${{ !inputs.skip-existing || steps.check-exists.outputs.exists == 'false' }}
        env:
          REGISTRY: ${{ inputs.registry }}
          REPOSITORY: ${{ inputs.repository }}
          PACKAGE_FILE: ${{ steps.package.outputs.package-file }}
        run: |
          echo "ðŸš€ Pushing chart to OCI registry..."
          helm push "$PACKAGE_FILE" "oci://${REGISTRY}/${REPOSITORY}"
          echo "âœ… Chart pushed successfully to ${REGISTRY}/${REPOSITORY}"

      - name: Skip push (already exists)
        if: inputs.skip-existing && steps.check-exists.outputs.exists == 'true'
        run: |
          echo "â­ï¸ Skipping push - ${{ steps.meta.outputs.name }}:${{ steps.meta.outputs.version }} already exists in registry"

      - name: Generate artifact attestation
        if: inputs.enable-provenance && (!inputs.skip-existing || steps.check-exists.outputs.exists == 'false') && inputs.registry == 'ghcr.io'
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ${{ steps.package.outputs.package-file }}

      - name: Upload chart package as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart-${{ steps.meta.outputs.name }}-${{ steps.meta.outputs.version }}
          path: .helm-packages/
          retention-days: 7

      - name: Generate summary
        if: always()
        run: |
          {
            echo "### âŽˆ Helm Package Results: ${{ steps.meta.outputs.name }}"
            echo ""
            echo "**Chart:** \`${{ steps.meta.outputs.name }}\`"
            echo "**Version:** \`${{ steps.meta.outputs.version }}\`"
            echo "**App Version:** \`${{ steps.meta.outputs.app-version }}\`"
            echo "**Type:** \`${{ steps.meta.outputs.type }}\`"
            echo "**Registry:** \`${{ inputs.registry }}/${{ inputs.repository }}\`"
            echo ""

            if [ "${{ inputs.skip-existing }}" = "true" ] && [ "${{ steps.check-exists.outputs.exists }}" = "true" ]; then
              echo "**Status:** â­ï¸ Skipped (already exists)"
            elif [ "${{ job.status }}" = "success" ]; then
              echo "**Status:** âœ… Packaged and pushed successfully"
              if [ "${{ inputs.enable-signing }}" = "true" ]; then
                echo "**Signing:** ðŸ” GPG signed"
              fi
              if [ "${{ inputs.enable-provenance }}" = "true" ]; then
                echo "**Provenance:** âœ… Enabled"
              fi
            else
              echo "**Status:** âŒ Failed"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
