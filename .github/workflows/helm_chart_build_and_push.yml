name: Helm Chart Build and Push

on:
  workflow_call:
    inputs:
      charts:
        description: "JSON array of chart configurations [{dir}]"
        required: true
        type: string
      base-path:
        description: "Base path for Helm charts (prepended to chart dirs)"
        required: false
        type: string
        default: ""
      registry:
        description: "OCI registry for Helm charts (e.g., ghcr.io, registry-1.docker.io)"
        required: false
        type: string
        default: "ghcr.io"
      repository:
        description: "Repository path in registry (e.g., owner/repo-name)"
        required: true
        type: string
      helm-version:
        description: "Helm version to use"
        required: false
        type: string
        default: "v3.19.2"
      enable-signing:
        description: "Enable chart signing with GPG"
        required: false
        type: boolean
        default: false
      enable-provenance:
        description: "Enable build provenance attestation"
        required: false
        type: boolean
        default: false
    secrets:
      registry-username:
        description: "Registry username"
        required: true
      registry-password:
        description: "Registry password/token"
        required: true
      gpg-private-key:
        description: "GPG private key for signing (base64 encoded)"
        required: false
      gpg-key-name:
        description: "GPG key name for signing"
        required: false
      gpg-passphrase:
        description: "GPG key passphrase"
        required: false

permissions:
  actions: read
  contents: read
  packages: write
  id-token: write
  attestations: write

jobs:
  package-and-push:
    name: Package and Push
    runs-on: ubuntu-latest
    if: fromJson(inputs.charts) != null && fromJson(inputs.charts)[0] != null
    strategy:
      matrix:
        chart: ${{ fromJson(inputs.charts) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ inputs.helm-version }}

      - name: Resolve paths
        id: paths
        run: |
          CHART_DIR="${{ matrix.chart.dir }}"
          if [ -n "${{ inputs.base-path }}" ]; then
            CHART_DIR="${{ inputs.base-path }}/${CHART_DIR}"
          fi
          echo "chart-dir=$CHART_DIR" >> "$GITHUB_OUTPUT"
          echo "Chart directory: $CHART_DIR"

      - name: Login to OCI registry
        env:
          REGISTRY: ${{ inputs.registry }}
          USERNAME: ${{ secrets.registry-username }}
          PASSWORD: ${{ secrets.registry-password }}
        run: |
          echo "$PASSWORD" | helm registry login "$REGISTRY" \
            --username "$USERNAME" \
            --password-stdin

      - name: Extract chart info
        id: extract
        run: |
          CHART_NAME=$(yq eval '.name' "${{ steps.paths.outputs.chart-dir }}/Chart.yaml")
          CHART_VERSION=$(yq eval '.version' "${{ steps.paths.outputs.chart-dir }}/Chart.yaml")
          CHART_APP_VERSION=$(yq eval '.appVersion' "${{ steps.paths.outputs.chart-dir }}/Chart.yaml")
          CHART_TYPE=$(yq eval '.type // "application"' "${{ steps.paths.outputs.chart-dir }}/Chart.yaml")

          {
            echo "chart-name=$CHART_NAME"
            echo "chart-version=$CHART_VERSION"
            echo "app-version=$CHART_APP_VERSION"
            echo "chart-type=$CHART_TYPE"
          } >> "$GITHUB_OUTPUT"

      - name: Prepare chart
        run: |
          echo "Chart type: ${{ steps.extract.outputs.chart-type }}"
          echo "Chart version: ${{ steps.extract.outputs.chart-version }}"
          if [ "${{ steps.extract.outputs.chart-type }}" != "library" ]; then
            echo "Chart appVersion: ${{ steps.extract.outputs.app-version }}"
          fi
          echo "Packaging chart with existing versions..."

      - name: Setup GPG
        if: inputs.enable-signing
        run: |
          echo "${{ secrets.gpg-private-key }}" | base64 -d | gpg --import --batch --yes
          echo "GPG key imported"

      - name: Package chart
        run: |
          mkdir -p .helm-packages

          if [ "${{ inputs.enable-signing }}" = "true" ]; then
            helm package ${{ steps.paths.outputs.chart-dir }} \
              --destination .helm-packages \
              --sign \
              --key "${{ secrets.gpg-key-name }}" \
              --keyring ~/.gnupg/pubring.gpg \
              --passphrase-file <(echo "${{ secrets.gpg-passphrase }}")
          else
            helm package ${{ steps.paths.outputs.chart-dir }} --destination .helm-packages
          fi

          ls -la .helm-packages/

      - name: Push chart to OCI registry
        env:
          REGISTRY: ${{ inputs.registry }}
          REPOSITORY: ${{ inputs.repository }}
          CHART_NAME: ${{ steps.extract.outputs.chart-name }}
          CHART_VERSION: ${{ steps.extract.outputs.chart-version }}
        run: |
          CHART_PACKAGE=$(ls ".helm-packages/${CHART_NAME}-${CHART_VERSION}.tgz")
          helm push "$CHART_PACKAGE" "oci://${REGISTRY}/${REPOSITORY}"

          echo "âœ… Chart pushed successfully to ${REGISTRY}/${REPOSITORY}"

      - name: Generate artifact attestation
        if: inputs.enable-provenance
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: .helm-packages/${{ steps.extract.outputs.chart-name }}-${{ steps.extract.outputs.chart-version }}.tgz
