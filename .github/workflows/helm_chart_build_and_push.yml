name: Helm Chart Build and Push

on:
  workflow_call:
    inputs:
      chart-name:
        description: 'Full chart name without registry (e.g., owner/charts/app)'
        required: true
        type: string
      chart-dir:
        description: 'Path to Helm chart directory (containing Chart.yaml)'
        required: true
        type: string
      registry:
        description: 'OCI registry for Helm charts (e.g., ghcr.io, registry-1.docker.io)'
        required: false
        type: string
        default: 'ghcr.io'
      helm-version:
        description: 'Helm version to use'
        required: false
        type: string
        default: 'v3.16.3'
      version-strategy:
        description: 'Version strategy: tag (use git tag), chart (use Chart.yaml version), auto (auto-increment)'
        required: false
        type: string
        default: 'chart'
      version-override:
        description: 'Override version (leave empty to use strategy)'
        required: false
        type: string
        default: ''
      app-version-strategy:
        description: 'App version strategy: tag (use git tag), sha (use commit sha), custom'
        required: false
        type: string
        default: 'tag'
      app-version-override:
        description: 'Override app version (leave empty to use strategy)'
        required: false
        type: string
        default: ''
      enable-signing:
        description: 'Enable chart signing with GPG'
        required: false
        type: boolean
        default: false
    secrets:
      registry-username:
        description: 'Registry username'
        required: true
      registry-password:
        description: 'Registry password/token'
        required: true
      gpg-private-key:
        description: 'GPG private key for signing (base64 encoded)'
        required: false
      gpg-passphrase:
        description: 'GPG key passphrase'
        required: false

permissions:
  actions: read
  contents: read
  packages: write

jobs:
  package-and-push:
    name: Package and Push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ inputs.helm-version }}

      - name: Extract chart info
        id: extract
        run: |
          CHART_VERSION=$(yq eval '.version' ${{ inputs.chart-dir }}/Chart.yaml)
          CHART_APP_VERSION=$(yq eval '.appVersion' ${{ inputs.chart-dir }}/Chart.yaml)

          echo "chart-version=$CHART_VERSION" >> $GITHUB_OUTPUT
          echo "app-version=$CHART_APP_VERSION" >> $GITHUB_OUTPUT

      - name: Determine version
        id: version
        run: |
          # Determine chart version
          if [ -n "${{ inputs.version-override }}" ]; then
            VERSION="${{ inputs.version-override }}"
          else
            case "${{ inputs.version-strategy }}" in
              tag)
                if [ "${{ github.ref_type }}" = "tag" ]; then
                  VERSION="${{ github.ref_name }}"
                  VERSION="${VERSION#v}"  # Remove 'v' prefix if exists
                else
                  echo "Error: tag strategy requires a git tag"
                  exit 1
                fi
                ;;
              chart)
                VERSION="${{ steps.extract.outputs.chart-version }}"
                ;;
              auto)
                VERSION="${{ steps.extract.outputs.chart-version }}"
                # Auto-increment patch version
                IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
                PATCH=$((PATCH + 1))
                VERSION="${MAJOR}.${MINOR}.${PATCH}"
                ;;
            esac
          fi

          # Determine app version
          if [ -n "${{ inputs.app-version-override }}" ]; then
            APP_VERSION="${{ inputs.app-version-override }}"
          else
            case "${{ inputs.app-version-strategy }}" in
              tag)
                if [ "${{ github.ref_type }}" = "tag" ]; then
                  APP_VERSION="${{ github.ref_name }}"
                else
                  APP_VERSION="dev-$(echo ${{ github.sha }} | cut -c1-7)"
                fi
                ;;
              sha)
                APP_VERSION="sha-$(echo ${{ github.sha }} | cut -c1-7)"
                ;;
              custom)
                APP_VERSION="${{ steps.extract.outputs.app-version }}"
                ;;
            esac
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "app-version=$APP_VERSION" >> $GITHUB_OUTPUT
          echo "Chart version: $VERSION"
          echo "App version: $APP_VERSION"

      - name: Update Chart.yaml versions
        run: |
          yq eval -i '.version = "${{ steps.version.outputs.version }}"' ${{ inputs.chart-dir }}/Chart.yaml
          yq eval -i '.appVersion = "${{ steps.version.outputs.app-version }}"' ${{ inputs.chart-dir }}/Chart.yaml

          echo "Updated Chart.yaml:"
          cat ${{ inputs.chart-dir }}/Chart.yaml

      - name: Setup GPG
        if: inputs.enable-signing
        run: |
          echo "${{ secrets.gpg-private-key }}" | base64 -d | gpg --import --batch --yes
          echo "GPG key imported"

      - name: Package chart
        run: |
          mkdir -p .helm-packages

          if [ "${{ inputs.enable-signing }}" = "true" ]; then
            helm package ${{ inputs.chart-dir }} \
              --destination .helm-packages \
              --sign \
              --key "${{ secrets.gpg-key-name }}" \
              --keyring ~/.gnupg/pubring.gpg \
              --passphrase-file <(echo "${{ secrets.gpg-passphrase }}")
          else
            helm package ${{ inputs.chart-dir }} --destination .helm-packages
          fi

          ls -la .helm-packages/

      - name: Get chart package name
        id: package
        run: |
          # Extract just the chart name from the full path
          CHART_BASENAME=$(basename ${{ inputs.chart-name }})
          PACKAGE_FILE=$(ls .helm-packages/${CHART_BASENAME}-${{ steps.version.outputs.version }}.tgz)
          echo "package-file=$PACKAGE_FILE" >> $GITHUB_OUTPUT

      - name: Login to OCI registry
        run: |
          echo "${{ secrets.registry-password }}" | helm registry login ${{ inputs.registry }} \
            --username ${{ secrets.registry-username }} \
            --password-stdin

      - name: Push chart to OCI registry
        run: |
          helm push "${{ steps.package.outputs.package-file }}" \
            oci://${{ inputs.registry }}/${{ inputs.chart-name }}

          echo "✅ Chart pushed successfully"

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: ${{ steps.package.outputs.package-file }}

      - name: Summary
        run: |
          echo "### ⎈ Helm Chart Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Chart:** \`${{ inputs.registry }}/${{ inputs.chart-name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**App Version:** ${{ steps.version.outputs.app-version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Install command:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "helm install my-release oci://${{ inputs.registry }}/${{ inputs.chart-name }} --version ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
