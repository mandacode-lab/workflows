name: Workflow Validation

on:
  pull_request:
    branches: [main]
    paths:
      - ".github/workflows/**"
  push:
    branches: [main]
    paths:
      - ".github/workflows/**"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  actionlint:
    name: Lint GitHub Actions Workflows
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup actionlint
        run: |
          go install github.com/rhysd/actionlint/cmd/actionlint@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Run actionlint
        run: |
          actionlint -color

  yamllint:
    name: Lint YAML Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: |
          yamllint -f colored .github/workflows/

  validate-structure:
    name: Validate Workflow Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check workflow files
        run: |
          echo "### üìã Workflow Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count workflow files
          WORKFLOW_COUNT=$(find .github/workflows -name '*.yml' -o -name '*.yaml' | wc -l)
          echo "**Total Workflows:** $WORKFLOW_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List workflows
          echo "**Workflow Files:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find .github/workflows -name '*.yml' -o -name '*.yaml' | sort >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check for workflow_call consistency
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reusable Workflows:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Find all workflow_call workflows
          for file in .github/workflows/*.yml; do
            if grep -q "workflow_call:" "$file"; then
              echo "‚úì $(basename $file)" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo '```' >> $GITHUB_STEP_SUMMARY

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [actionlint, yamllint, validate-structure]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "### ‚úÖ Workflow Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.actionlint.result }}" = "success" ]; then
            echo "- ‚úÖ actionlint: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ùå actionlint: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.yamllint.result }}" = "success" ]; then
            echo "- ‚úÖ yamllint: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ùå yamllint: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.validate-structure.result }}" = "success" ]; then
            echo "- ‚úÖ structure validation: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ùå structure validation: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check overall status
        run: |
          if [ "${{ needs.actionlint.result }}" != "success" ] || \
             [ "${{ needs.yamllint.result }}" != "success" ] || \
             [ "${{ needs.validate-structure.result }}" != "success" ]; then
            echo "‚ùå Some validation checks failed"
            exit 1
          fi
          echo "‚úÖ All validation checks passed"
