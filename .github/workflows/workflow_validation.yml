name: Workflow Validation

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - ".github/workflows/**"
  push:
    branches:
      - main
      - develop
    paths:
      - ".github/workflows/**"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  actionlint:
    name: Lint GitHub Actions Workflows
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup actionlint
        run: |
          go install github.com/rhysd/actionlint/cmd/actionlint@latest
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Run actionlint
        run: |
          actionlint -color

  yamllint:
    name: Lint YAML Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: |
          yamllint -f colored .github/workflows/

  validate-structure:
    name: Validate Workflow Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check workflow files
        run: |
          {
            echo "### üìã Workflow Validation Results"
            echo ""

            # Count workflow files
            WORKFLOW_COUNT=$(find .github/workflows -name '*.yml' -o -name '*.yaml' | wc -l)
            echo "**Total Workflows:** $WORKFLOW_COUNT"
            echo ""

            # List workflows
            echo "**Workflow Files:**"
            echo '```'
            find .github/workflows -name '*.yml' -o -name '*.yaml' | sort
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Check for workflow_call consistency
        run: |
          {
            echo ""
            echo "**Reusable Workflows:**"
            echo '```'

            # Find all workflow_call workflows
            for file in .github/workflows/*.yml; do
              if grep -q "workflow_call:" "$file"; then
                echo "‚úì $(basename "$file")"
              fi
            done

            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [actionlint, yamllint, validate-structure]
    if: always()
    steps:
      - name: Generate summary
        run: |
          {
            echo "### ‚úÖ Workflow Validation Complete"
            echo ""

            if [ "${{ needs.actionlint.result }}" = "success" ]; then
              echo "- ‚úÖ actionlint: PASSED"
            else
              echo "- ‚ùå actionlint: FAILED"
            fi

            if [ "${{ needs.yamllint.result }}" = "success" ]; then
              echo "- ‚úÖ yamllint: PASSED"
            else
              echo "- ‚ùå yamllint: FAILED"
            fi

            if [ "${{ needs.validate-structure.result }}" = "success" ]; then
              echo "- ‚úÖ structure validation: PASSED"
            else
              echo "- ‚ùå structure validation: FAILED"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Check overall status
        run: |
          if [ "${{ needs.actionlint.result }}" != "success" ] || \
             [ "${{ needs.yamllint.result }}" != "success" ] || \
             [ "${{ needs.validate-structure.result }}" != "success" ]; then
            echo "‚ùå Some validation checks failed"
            exit 1
          fi
          echo "‚úÖ All validation checks passed"
