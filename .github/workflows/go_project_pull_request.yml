name: Go Project Pull Request Check

on:
  workflow_call:
    inputs:
      go-version:
        description: "Go version to use"
        required: false
        type: string
        default: "1.25.5"
      build-path:
        description: "Path to build"
        required: false
        type: string
        default: "./..."
      test-path:
        description: "Path to test"
        required: false
        type: string
        default: "./..."
      test-flags:
        description: "Additional test flags"
        required: false
        type: string
        default: "-v -race"
      enable-coverage:
        description: "Enable coverage report"
        required: false
        type: boolean
        default: true
      coverage-threshold:
        description: "Minimum coverage percentage"
        required: false
        type: number
        default: 0
      lint-version:
        description: "golangci-lint version"
        required: false
        type: string
        default: "latest"
      lint-args:
        description: "golangci-lint arguments"
        required: false
        type: string
        default: "./..."
      enable-security-scan:
        description: "Enable security scanning"
        required: false
        type: boolean
        default: true
      enable-dockerfile-test:
        description: "Enable Dockerfile testing"
        required: false
        type: boolean
        default: true
      dockerfile-path:
        description: "Path to Dockerfiles directory"
        required: false
        type: string
        default: "build"
      dockerfile-pattern:
        description: "Dockerfile pattern to match"
        required: false
        type: string
        default: "Dockerfile.*"
      dockerfile-exclude-pattern:
        description: "Dockerfile pattern to exclude"
        required: false
        type: string
        default: "Dockerfile.migration"
      build-context:
        description: "Docker build context path"
        required: false
        type: string
        default: "."
      enable-helm-test:
        description: "Enable Helm chart testing"
        required: false
        type: boolean
        default: false
      helm-chart-dir:
        description: "Path to Helm chart directory"
        required: false
        type: string
        default: "helm"
      enable-migration-test:
        description: "Enable migration PR check"
        required: false
        type: boolean
        default: false
      migration-dir:
        description: "Path to migration directory"
        required: false
        type: string
        default: "migrations"

permissions:
  actions: read
  contents: read
  pull-requests: read
  security-events: write
  packages: read

jobs:
  go-check:
    name: Go Check
    uses: ./.github/workflows/go_pull_request.yml
    with:
      go-version: ${{ inputs.go-version }}
      build-path: ${{ inputs.build-path }}
      test-path: ${{ inputs.test-path }}
      test-flags: ${{ inputs.test-flags }}
      enable-coverage: ${{ inputs.enable-coverage }}
      coverage-threshold: ${{ inputs.coverage-threshold }}
      lint-version: ${{ inputs.lint-version }}
      lint-args: ${{ inputs.lint-args }}
      enable-security-scan: ${{ inputs.enable-security-scan }}

  find-dockerfiles:
    name: Find Dockerfiles
    runs-on: ubuntu-latest
    if: inputs.enable-dockerfile-test
    outputs:
      dockerfiles: ${{ steps.find.outputs.dockerfiles }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Find Dockerfiles
        id: find
        run: |
          # Find all Dockerfiles matching pattern, excluding specified pattern
          DOCKERFILES=$(find ${{ inputs.dockerfile-path }} -type f -name '${{ inputs.dockerfile-pattern }}' ! -name '${{ inputs.dockerfile-exclude-pattern }}' | jq -R -s -c 'split("\n")[:-1]')
          echo "dockerfiles=$DOCKERFILES" >> $GITHUB_OUTPUT
          echo "Found Dockerfiles:"
          echo "  Pattern: ${{ inputs.dockerfile-pattern }}"
          echo "  Exclude: ${{ inputs.dockerfile-exclude-pattern }}"
          echo "$DOCKERFILES" | jq -r '.[]'

  dockerfile-test:
    name: Dockerfile Test
    runs-on: ubuntu-latest
    needs: find-dockerfiles
    if: inputs.enable-dockerfile-test && needs.find-dockerfiles.outputs.dockerfiles != '[]'
    strategy:
      matrix:
        dockerfile: ${{ fromJson(needs.find-dockerfiles.outputs.dockerfiles) }}
      fail-fast: false
    steps:
      - name: Test Dockerfile
        uses: ./.github/workflows/dockerfile_test.yml
        with:
          dockerfile-path: ${{ matrix.dockerfile }}
          build-context: ${{ inputs.build-context }}

  helm-test:
    name: Helm Chart Test
    if: inputs.enable-helm-test
    uses: ./.github/workflows/helm_chart_test.yml
    with:
      chart-dir: ${{ inputs.helm-chart-dir }}

  migration-check:
    name: Migration Check
    if: inputs.enable-migration-test
    uses: ./.github/workflows/migration_pull_request.yml
    with:
      migration-dir: ${{ inputs.migration-dir }}
