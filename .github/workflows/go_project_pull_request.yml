name: Go Project Pull Request Check

on:
  workflow_call:
    inputs:
      go-version:
        description: "Go version to use"
        required: false
        type: string
        default: "1.25.5"
      build-path:
        description: "Path to build"
        required: false
        type: string
        default: "./..."
      test-path:
        description: "Path to test"
        required: false
        type: string
        default: "./..."
      test-flags:
        description: "Additional test flags"
        required: false
        type: string
        default: "-v -race"
      enable-coverage:
        description: "Enable coverage report"
        required: false
        type: boolean
        default: true
      coverage-threshold:
        description: "Minimum coverage percentage"
        required: false
        type: number
        default: 0
      lint-version:
        description: "golangci-lint version"
        required: false
        type: string
        default: "latest"
      lint-args:
        description: "golangci-lint arguments"
        required: false
        type: string
        default: "./..."
      enable-security-scan:
        description: "Enable security scanning"
        required: false
        type: boolean
        default: true
      enable-dockerfile-test:
        description: "Enable Dockerfile testing"
        required: false
        type: boolean
        default: false
      images:
        description: 'JSON array of Dockerfile paths [{dockerfile"}]'
        required: false
        type: string
        default: "[]"
      image-base-path:
        description: "Base path for Dockerfiles"
        required: false
        type: string
        default: ""
      build-context:
        description: "Docker build context path"
        required: false
        type: string
        default: "."
      enable-helm-test:
        description: "Enable Helm chart testing"
        required: false
        type: boolean
        default: false
      helm-charts:
        description: "JSON array of Helm chart directories [{dir}]"
        required: false
        type: string
        default: "[]"
      helm-base-path:
        description: "Base path for Helm charts"
        required: false
        type: string
        default: ""

permissions:
  actions: read
  contents: read
  pull-requests: read
  security-events: write
  packages: read

jobs:
  go-check:
    name: Go Check
    uses: ./.github/workflows/go_pull_request.yml
    with:
      go-version: ${{ inputs.go-version }}
      build-path: ${{ inputs.build-path }}
      test-path: ${{ inputs.test-path }}
      test-flags: ${{ inputs.test-flags }}
      enable-coverage: ${{ inputs.enable-coverage }}
      coverage-threshold: ${{ inputs.coverage-threshold }}
      lint-version: ${{ inputs.lint-version }}
      lint-args: ${{ inputs.lint-args }}
      enable-security-scan: ${{ inputs.enable-security-scan }}

  dockerfile-test:
    name: Dockerfile Test
    if: inputs.enable-dockerfile-test && fromJson(inputs.images) != null && fromJson(inputs.images)[0] != null
    uses: ./.github/workflows/dockerfile_test.yml
    with:
      images: ${{ inputs.images }}
      base-path: ${{ inputs.image-base-path }}
      build-context: ${{ inputs.build-context }}

  helm-test:
    name: Helm Chart Test
    if: inputs.enable-helm-test && fromJson(inputs.helm-charts) != null && fromJson(inputs.helm-charts)[0] != null
    uses: ./.github/workflows/helm_chart_test.yml
    with:
      charts: ${{ inputs.helm-charts }}
      base-path: ${{ inputs.helm-base-path }}
