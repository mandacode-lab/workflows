name: Workflow Lint

# Workflow for validating GitHub Actions workflows
# Automatically runs on workflow changes
# Includes: actionlint, yamllint, and structure validation

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - ".github/workflows/**"
  push:
    branches:
      - main
      - develop
    paths:
      - ".github/workflows/**"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  actionlint:
    name: Lint GitHub Actions
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.5"
          cache: false

      - name: Install actionlint
        run: |
          go install github.com/rhysd/actionlint/cmd/actionlint@latest
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Verify actionlint installation
        run: |
          actionlint -version

      - name: Run actionlint
        run: |
          echo "üîç Running actionlint on workflow files..."
          actionlint -color -verbose
          echo "‚úÖ actionlint passed"

      - name: Generate actionlint summary
        if: always()
        run: |
          {
            echo "### üîç actionlint Results"
            echo ""
            if [ "${{ job.status }}" = "success" ]; then
              echo "**Status:** ‚úÖ All workflows are valid"
            else
              echo "**Status:** ‚ùå Workflow validation failed"
              echo ""
              echo "Please fix the issues reported above."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  yamllint:
    name: Lint YAML Files
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install yamllint
        run: |
          pip install yamllint
          yamllint --version

      - name: Create yamllint config
        run: |
          cat > .yamllint.yml <<EOF
          ---
          extends: default

          rules:
            line-length:
              max: 150
              level: warning
            comments:
              min-spaces-from-content: 1
            comments-indentation: disable
            truthy:
              allowed-values: ['true', 'false', 'on', 'off']
              check-keys: false
            indentation:
              spaces: 2
              indent-sequences: true
          EOF

      - name: Run yamllint
        run: |
          echo "üîç Running yamllint on workflow files..."
          yamllint -f colored .github/workflows/
          echo "‚úÖ yamllint passed"

      - name: Generate yamllint summary
        if: always()
        run: |
          {
            echo "### üìù yamllint Results"
            echo ""
            if [ "${{ job.status }}" = "success" ]; then
              echo "**Status:** ‚úÖ YAML syntax is valid"
            else
              echo "**Status:** ‚ùå YAML syntax issues found"
              echo ""
              echo "Please fix the YAML formatting issues reported above."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  validate-structure:
    name: Validate Structure
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Count workflow files
        id: count
        run: |
          WORKFLOW_COUNT=$(find .github/workflows -name '*.yml' -o -name '*.yaml' | wc -l)
          echo "count=$WORKFLOW_COUNT" >> "$GITHUB_OUTPUT"
          echo "üìä Total workflows: $WORKFLOW_COUNT"

      - name: List workflow files
        run: |
          echo "üìã Workflow files:"
          find .github/workflows -name '*.yml' -o -name '*.yaml' | sort | sed 's/^/  /'

      - name: Check for reusable workflows
        id: reusable
        run: |
          echo "üîç Checking for reusable workflows..."

          REUSABLE_WORKFLOWS=()
          CALLER_WORKFLOWS=()

          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              if grep -q "workflow_call:" "$file"; then
                REUSABLE_WORKFLOWS+=("$(basename "$file")")
              fi
              if grep -q "uses:.*/.github/workflows/" "$file"; then
                CALLER_WORKFLOWS+=("$(basename "$file")")
              fi
            fi
          done

          echo "reusable-count=${#REUSABLE_WORKFLOWS[@]}" >> "$GITHUB_OUTPUT"
          echo "caller-count=${#CALLER_WORKFLOWS[@]}" >> "$GITHUB_OUTPUT"

          echo ""
          echo "üì¶ Reusable workflows (${#REUSABLE_WORKFLOWS[@]}):"
          printf '  %s\n' "${REUSABLE_WORKFLOWS[@]}"

          echo ""
          echo "üîó Caller workflows (${#CALLER_WORKFLOWS[@]}):"
          printf '  %s\n' "${CALLER_WORKFLOWS[@]}"

      - name: Check for deprecated syntax
        run: |
          echo "üîç Checking for deprecated syntax..."

          DEPRECATED_FOUND=false

          # Check for set-output (deprecated) - exclude workflow-lint.yml itself
          if grep -r "set-output" .github/workflows/ --exclude="workflow-lint.yml" 2>/dev/null; then
            echo "‚ö†Ô∏è Found deprecated 'set-output' command"
            echo "   Use 'echo \"key=value\" >> \$GITHUB_OUTPUT' instead"
            DEPRECATED_FOUND=true
          fi

          # Check for save-state (deprecated) - exclude workflow-lint.yml itself
          if grep -r "save-state" .github/workflows/ --exclude="workflow-lint.yml" 2>/dev/null; then
            echo "‚ö†Ô∏è Found deprecated 'save-state' command"
            echo "   Use 'echo \"key=value\" >> \$GITHUB_STATE' instead"
            DEPRECATED_FOUND=true
          fi

          # Check for add-path (deprecated) - exclude workflow-lint.yml itself
          if grep -r "add-path" .github/workflows/ --exclude="workflow-lint.yml" 2>/dev/null; then
            echo "‚ö†Ô∏è Found deprecated 'add-path' command"
            echo "   Use 'echo \"path\" >> \$GITHUB_PATH' instead"
            DEPRECATED_FOUND=true
          fi

          if [ "$DEPRECATED_FOUND" = false ]; then
            echo "‚úÖ No deprecated syntax found"
          else
            echo ""
            echo "‚ö†Ô∏è Please update deprecated syntax"
            exit 1
          fi

      - name: Generate structure summary
        if: always()
        run: |
          {
            echo "### üìã Workflow Structure Validation"
            echo ""
            echo "**Total Workflows:** ${{ steps.count.outputs.count }}"
            echo "**Reusable Workflows:** ${{ steps.reusable.outputs.reusable-count }}"
            echo "**Caller Workflows:** ${{ steps.reusable.outputs.caller-count }}"
            echo ""

            if [ "${{ job.status }}" = "success" ]; then
              echo "**Status:** ‚úÖ Structure is valid"
            else
              echo "**Status:** ‚ùå Structure validation failed"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [actionlint, yamllint, validate-structure]
    if: always()
    steps:
      - name: Generate final summary
        run: |
          {
            echo "### ‚úÖ Workflow Validation Complete"
            echo ""

            if [ "${{ needs.actionlint.result }}" = "success" ]; then
              echo "- ‚úÖ **actionlint:** PASSED"
            else
              echo "- ‚ùå **actionlint:** FAILED"
            fi

            if [ "${{ needs.yamllint.result }}" = "success" ]; then
              echo "- ‚úÖ **yamllint:** PASSED"
            else
              echo "- ‚ùå **yamllint:** FAILED"
            fi

            if [ "${{ needs.validate-structure.result }}" = "success" ]; then
              echo "- ‚úÖ **structure validation:** PASSED"
            else
              echo "- ‚ùå **structure validation:** FAILED"
            fi

            echo ""

            if [ "${{ needs.actionlint.result }}" = "success" ] && \
               [ "${{ needs.yamllint.result }}" = "success" ] && \
               [ "${{ needs.validate-structure.result }}" = "success" ]; then
              echo "üéâ **All validation checks passed!**"
            else
              echo "‚ö†Ô∏è **Some validation checks failed. Please review the errors above.**"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Check overall status
        run: |
          if [ "${{ needs.actionlint.result }}" != "success" ] || \
             [ "${{ needs.yamllint.result }}" != "success" ] || \
             [ "${{ needs.validate-structure.result }}" != "success" ]; then
            echo "‚ùå Validation failed"
            exit 1
          fi
          echo "‚úÖ All validation checks passed"
