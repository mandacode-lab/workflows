name: Helm Chart Test

on:
  workflow_call:
    inputs:
      charts:
        description: 'JSON array of chart directories [{dir}]'
        required: true
        type: string
      base-path:
        description: 'Base path for Helm charts (prepended to chart dirs)'
        required: false
        type: string
        default: ''
      helm-version:
        description: 'Helm version to use'
        required: false
        type: string
        default: 'v3.16.3'
      kubernetes-version:
        description: 'Kubernetes version for testing'
        required: false
        type: string
        default: 'v1.31.2'
      enable-kubeconform:
        description: 'Enable kubeconform validation'
        required: false
        type: boolean
        default: true
      enable-kubeval:
        description: 'Enable kubeval validation'
        required: false
        type: boolean
        default: false
      enable-polaris:
        description: 'Enable Polaris best practices check'
        required: false
        type: boolean
        default: true

permissions:
  actions: read
  contents: read

jobs:
  lint:
    name: Helm Lint
    runs-on: ubuntu-latest
    if: fromJson(inputs.charts) != null && fromJson(inputs.charts)[0] != null
    strategy:
      matrix:
        item: ${{ fromJson(inputs.charts) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ inputs.helm-version }}

      - name: Resolve paths
        id: paths
        run: |
          CHART_DIR="${{ matrix.item.dir }}"
          if [ -n "${{ inputs.base-path }}" ]; then
            CHART_DIR="${{ inputs.base-path }}/${CHART_DIR}"
          fi
          echo "chart-dir=$CHART_DIR" >> "$GITHUB_OUTPUT"
          echo "Chart directory: $CHART_DIR"

      - name: Helm lint
        run: |
          echo "Linting Helm chart..."
          helm lint ${{ steps.paths.outputs.chart-dir }}

      - name: Helm template
        run: |
          echo "Templating Helm chart..."
          helm template test ${{ steps.paths.outputs.chart-dir }} --debug

  kubeconform:
    name: Kubeconform Validation
    runs-on: ubuntu-latest
    if: inputs.enable-kubeconform && fromJson(inputs.charts) != null && fromJson(inputs.charts)[0] != null
    strategy:
      matrix:
        item: ${{ fromJson(inputs.charts) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ inputs.helm-version }}

      - name: Setup kubeconform
        run: |
          wget https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Resolve paths
        id: paths
        run: |
          CHART_DIR="${{ matrix.item.dir }}"
          if [ -n "${{ inputs.base-path }}" ]; then
            CHART_DIR="${{ inputs.base-path }}/${CHART_DIR}"
          fi
          echo "chart-dir=$CHART_DIR" >> "$GITHUB_OUTPUT"

      - name: Validate with kubeconform
        run: |
          echo "Validating with kubeconform..."
          helm template test ${{ steps.paths.outputs.chart-dir }} | kubeconform \
            -kubernetes-version ${{ inputs.kubernetes-version }} \
            -schema-location default \
            -strict \
            -summary

  kubeval:
    name: Kubeval Validation
    runs-on: ubuntu-latest
    if: inputs.enable-kubeval && fromJson(inputs.charts) != null && fromJson(inputs.charts)[0] != null
    strategy:
      matrix:
        item: ${{ fromJson(inputs.charts) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ inputs.helm-version }}

      - name: Setup kubeval
        run: |
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin/

      - name: Resolve paths
        id: paths
        run: |
          CHART_DIR="${{ matrix.item.dir }}"
          if [ -n "${{ inputs.base-path }}" ]; then
            CHART_DIR="${{ inputs.base-path }}/${CHART_DIR}"
          fi
          echo "chart-dir=$CHART_DIR" >> "$GITHUB_OUTPUT"

      - name: Validate with kubeval
        run: |
          echo "Validating with kubeval..."
          helm template test ${{ steps.paths.outputs.chart-dir }} | kubeval \
            --kubernetes-version ${{ inputs.kubernetes-version }} \
            --strict

  polaris:
    name: Polaris Best Practices
    runs-on: ubuntu-latest
    if: inputs.enable-polaris && fromJson(inputs.charts) != null && fromJson(inputs.charts)[0] != null
    strategy:
      matrix:
        item: ${{ fromJson(inputs.charts) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ inputs.helm-version }}

      - name: Resolve paths
        id: paths
        run: |
          CHART_DIR="${{ matrix.item.dir }}"
          if [ -n "${{ inputs.base-path }}" ]; then
            CHART_DIR="${{ inputs.base-path }}/${CHART_DIR}"
          fi
          echo "chart-dir=$CHART_DIR" >> "$GITHUB_OUTPUT"

      - name: Run Polaris
        uses: fairwindsops/polaris-action@v0.1.0
        with:
          helm-chart: ${{ steps.paths.outputs.chart-dir }}
          helm-values: ${{ steps.paths.outputs.chart-dir }}/values.yaml

  install-test:
    name: Helm Install Test
    runs-on: ubuntu-latest
    if: fromJson(inputs.charts) != null && fromJson(inputs.charts)[0] != null
    strategy:
      matrix:
        item: ${{ fromJson(inputs.charts) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ inputs.helm-version }}

      - name: Setup Kind
        uses: helm/kind-action@v1
        with:
          version: v0.25.0
          kubectl_version: ${{ inputs.kubernetes-version }}

      - name: Resolve paths
        id: paths
        run: |
          CHART_DIR="${{ matrix.item.dir }}"
          if [ -n "${{ inputs.base-path }}" ]; then
            CHART_DIR="${{ inputs.base-path }}/${CHART_DIR}"
          fi
          echo "chart-dir=$CHART_DIR" >> "$GITHUB_OUTPUT"

      - name: Install chart
        run: |
          echo "Installing Helm chart in Kind cluster..."
          helm install test-release ${{ steps.paths.outputs.chart-dir }} \
            --wait --timeout 5m --debug \
            --dry-run

      - name: Chart info
        run: |
          {
            echo "### ⎈ Helm Chart Test Results"
            echo "**Chart:** ${{ steps.paths.outputs.chart-dir }}"
            echo "**Status:** ✅ Passed"
          } >> "$GITHUB_STEP_SUMMARY"
