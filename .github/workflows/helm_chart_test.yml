name: Helm Chart Test

on:
  workflow_call:
    inputs:
      charts:
        description: "JSON array of chart directories [{dir}]"
        required: true
        type: string
      base-path:
        description: "Base path for Helm charts (prepended to chart dirs)"
        required: false
        type: string
        default: ""
      helm-version:
        description: "Helm version to use"
        required: false
        type: string
        default: "v3.16.3"
      kubernetes-version:
        description: "Kubernetes version for testing"
        required: false
        type: string
        default: "v1.35.0"
      enable-kubeconform:
        description: "Enable kubeconform validation (ignored for library charts)"
        required: false
        type: boolean
        default: true

permissions:
  actions: read
  contents: read

jobs:
  lint:
    name: Helm Lint
    runs-on: ubuntu-latest
    if: fromJson(inputs.charts) != null && fromJson(inputs.charts)[0] != null
    strategy:
      matrix:
        item: ${{ fromJson(inputs.charts) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ inputs.helm-version }}

      - name: Resolve paths
        id: paths
        run: |
          CHART_DIR="${{ matrix.item.dir }}"
          if [ -n "${{ inputs.base-path }}" ]; then
            CHART_DIR="${{ inputs.base-path }}/${CHART_DIR}"
          fi
          echo "chart-dir=$CHART_DIR" >> "$GITHUB_OUTPUT"
          echo "Chart directory: $CHART_DIR"

      - name: Detect chart type
        id: detect
        run: |
          CHART_TYPE=$(yq eval '.type // "application"' "${{ steps.paths.outputs.chart-dir }}/Chart.yaml")
          echo "chart-type=$CHART_TYPE" >> "$GITHUB_OUTPUT"
          echo "Chart type: $CHART_TYPE"

      - name: Build dependencies
        run: |
          cd "${{ steps.paths.outputs.chart-dir }}"
          if [ -f "Chart.yaml" ] && yq eval '.dependencies' Chart.yaml > /dev/null 2>&1; then
            helm dependency build
          else
            echo "No dependencies found"
          fi

      - name: Helm lint
        run: |
          helm lint ${{ steps.paths.outputs.chart-dir }}

      - name: Helm template
        if: steps.detect.outputs.chart-type != 'library'
        run: |
          helm template test ${{ steps.paths.outputs.chart-dir }} --debug

  kubeconform:
    name: Kubeconform Validation
    runs-on: ubuntu-latest
    if: inputs.enable-kubeconform && fromJson(inputs.charts) != null && fromJson(inputs.charts)[0] != null
    strategy:
      matrix:
        item: ${{ fromJson(inputs.charts) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ inputs.helm-version }}

      - name: Setup kubeconform
        run: |
          wget https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Resolve paths
        id: paths
        run: |
          CHART_DIR="${{ matrix.item.dir }}"
          if [ -n "${{ inputs.base-path }}" ]; then
            CHART_DIR="${{ inputs.base-path }}/${CHART_DIR}"
          fi
          echo "chart-dir=$CHART_DIR" >> "$GITHUB_OUTPUT"

      - name: Detect chart type
        id: detect
        run: |
          CHART_TYPE=$(yq eval '.type // "application"' "${{ steps.paths.outputs.chart-dir }}/Chart.yaml")
          echo "chart-type=$CHART_TYPE" >> "$GITHUB_OUTPUT"
          echo "Chart type: $CHART_TYPE"

      - name: Build dependencies
        run: |
          cd "${{ steps.paths.outputs.chart-dir }}"
          if [ -f "Chart.yaml" ] && yq eval '.dependencies' Chart.yaml > /dev/null 2>&1; then
            helm dependency build
          else
            echo "No dependencies found"
          fi

      - name: Validate with kubeconform
        if: steps.detect.outputs.chart-type != 'library'
        run: |
          K8S_VERSION="${{ inputs.kubernetes-version }}"
          K8S_VERSION="${K8S_VERSION#v}"
          helm template test ${{ steps.paths.outputs.chart-dir }} | kubeconform \
            -kubernetes-version "$K8S_VERSION" \
            -schema-location default \
            -strict \
            -summary

      - name: Skip kubeconform for library chart
        if: steps.detect.outputs.chart-type == 'library'
        run: |
          echo "â­ï¸ Skipping kubeconform validation for library chart"

  install-test:
    name: Helm Install Test
    runs-on: ubuntu-latest
    if: fromJson(inputs.charts) != null && fromJson(inputs.charts)[0] != null
    strategy:
      matrix:
        item: ${{ fromJson(inputs.charts) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ inputs.helm-version }}

      - name: Resolve paths
        id: paths
        run: |
          CHART_DIR="${{ matrix.item.dir }}"
          if [ -n "${{ inputs.base-path }}" ]; then
            CHART_DIR="${{ inputs.base-path }}/${CHART_DIR}"
          fi
          echo "chart-dir=$CHART_DIR" >> "$GITHUB_OUTPUT"

      - name: Detect chart type
        id: detect
        run: |
          CHART_TYPE=$(yq eval '.type // "application"' "${{ steps.paths.outputs.chart-dir }}/Chart.yaml")
          echo "chart-type=$CHART_TYPE" >> "$GITHUB_OUTPUT"
          echo "Chart type: $CHART_TYPE"

      - name: Update dependencies
        if: steps.detect.outputs.chart-type != 'library'
        run: |
          cd "${{ steps.paths.outputs.chart-dir }}"
          if [ -f "Chart.yaml" ] && yq eval '.dependencies' Chart.yaml > /dev/null 2>&1; then
            echo "Updating chart dependencies..."
            helm dependency update
          else
            echo "No dependencies found, skipping dependency update"
          fi

      - name: Setup Kind
        if: steps.detect.outputs.chart-type != 'library'
        uses: helm/kind-action@v1
        with:
          version: v0.25.0
          kubectl_version: ${{ inputs.kubernetes-version }}

      - name: Install chart
        if: steps.detect.outputs.chart-type != 'library'
        run: |
          helm install test-release ${{ steps.paths.outputs.chart-dir }} \
            --wait --timeout 5m --debug \
            --dry-run

      - name: Skip install test for library chart
        if: steps.detect.outputs.chart-type == 'library'
        run: |
          echo "â­ï¸ Skipping install test for library chart (library charts cannot be installed independently)"

      - name: Chart info
        run: |
          CHART_NAME=$(yq eval '.name' "${{ steps.paths.outputs.chart-dir }}/Chart.yaml")
          CHART_VERSION=$(yq eval '.version' "${{ steps.paths.outputs.chart-dir }}/Chart.yaml")
          CHART_TYPE="${{ steps.detect.outputs.chart-type }}"

          {
            if [ "$CHART_TYPE" = "library" ]; then
              echo "### ðŸ“š Helm Library Chart Test Results"
            else
              echo "### âŽˆ Helm Chart Test Results"
            fi
            echo "**Chart:** $CHART_NAME"
            echo "**Version:** $CHART_VERSION"
            echo "**Type:** $CHART_TYPE"
            echo "**Status:** âœ… Passed"
          } >> "$GITHUB_STEP_SUMMARY"
